# RPM跳变问题 - 快速参考卡片

## 现象
```
目标RPM: 200
实际RPM: 166 ↔ 333 (不断跳变)
```

## 原因
```
脉冲周期 (~7ms) ≠ 检测周期的整数倍 (20ms)
↓
每个20ms检测到的脉冲数不稳定 (1, 2, 1, 2, ...)
↓
RPM = (脉冲数 × 3000) / 18
    = 166 (1脉冲), 333 (2脉冲), ...
```

## 解决方案
```
✓ 使用最近5个周期(100ms)的脉冲数平均值
✓ 消除短期波动
✓ 使RPM显示平滑收敛
```

## 修改的文件

| 文件 | 修改内容 |
|------|---------|
| motor_ctrl.h | 添加RPM_FILTER_SIZE定义，导出motor_rpm_raw |
| motor_ctrl.c | 实现RPM移动平均滤波，添加history缓冲 |

## Debug变量
```c
pulse_count         // 每个周期的脉冲数 (1, 2, 1, 2, ...)
motor_rpm_raw       // 原始RPM (166, 333, 166, 333, ...) 
motor_rpm           // 平滑后RPM (0, 33, 100, 166, 200, ...)
exti_trigger_count  // 中断触发计数 (持续增加)
```

## 验证步骤
1. [ ] 编译通过
2. [ ] Debug观察motor_rpm变化
3. [ ] 验证PID控制能否正常工作
4. [ ] 测试电机在目标RPM处稳定性

## 预期结果
```
修改前: RPM在166和333间快速闪烁
修改后: RPM平滑增长，最终稳定在200±10
```

## 如果问题仍存在

1. **检查PPR值**
   ```
   脉冲: 120-140Hz → 对应400-467RPM (PPR=18)
   但目标是200RPM → PPR应该是36?
   ```

2. **检查中断**
   ```
   exti_trigger_count应该持续增加
   如果为0，说明中断未触发
   ```

3. **检查脉冲信号**
   ```
   示波器观察PB0是否有120-140Hz方波
   ```

## 关键数据
```
脉冲频率:      120-140 Hz (实测)
PPR:           18 脉冲/转
检测周期:      20ms (50Hz)
每周期脉冲数:  2-3个 (120-140Hz ÷ 50Hz)
滤波大小:      5个周期 = 100ms
收敛时间:      ~100ms
```

