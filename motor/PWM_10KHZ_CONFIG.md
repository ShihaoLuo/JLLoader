# PWM 10kHz 配置说明

## 修改总结

已成功将PWM频率从500Hz升级到10.26kHz，同时**保持占空比精度0.2%不变**。

## 参数对比

| 参数 | 原配置(500Hz) | 新配置(10.26kHz) | 变化 |
|------|--------------|-----------------|------|
| **Prescaler** | 143 | 6 | ÷24 |
| **Period** | 500 | 500 | ✓ 不变 |
| **时钟频率** | 36MHz/(143+1)=250kHz | 36MHz/(6+1)=5.14MHz | ×20.6 |
| **PWM周期** | (500+1)/250kHz=2.004ms | (500+1)/5.14MHz=0.0974ms | ÷20.6 |
| **PWM频率** | 500Hz | 10.26kHz | ×20.6 |
| **占空比精度** | 1/500=0.2% | 1/500=0.2% | ✓ 保持 |
| **占空比分级** | 500级 | 500级 | ✓ 保持 |

## 计算验证

### 新频率计算

```
时钟频率 = 36MHz / (Prescaler + 1)
         = 36MHz / (6 + 1)
         = 36MHz / 7
         = 5.142857 MHz

PWM频率 = 时钟频率 / (Period + 1)
        = 5.142857MHz / (500 + 1)
        = 5.142857MHz / 501
        = 10.26 kHz ✓
```

### 占空比精度验证

```
占空比分级 = (Period + 1) 个步长
          = 501 个步长 (Pulse: 0~500)

占空比精度 = 100% / 500
           = 0.2% ✓ (与原配置相同)

例如：
  Pulse=250 → 占空比=250/500×100% = 50.0%
  Pulse=100 → 占空比=100/500×100% = 20.0%
  Pulse=1   → 占空比=1/500×100% = 0.2%
```

## 代码变更

### motor_init.c - MX_TIM3_Init()

```c
// 原配置
htim3.Init.Prescaler = 143;    // 36MHz / 144 = 250kHz

// 新配置
htim3.Init.Prescaler = 6;      // 36MHz / 7 = 5.14MHz
```

**其他参数保持不变：**
- Period: 500 (保持占空比精度)
- Pulse: 500 (初始占空比100%)
- OCMode: TIM_OCMODE_PWM1
- OCPolarity: TIM_OCPOLARITY_HIGH

## motor_ctrl.h 中的定义

✓ **无需修改**，保持原样：

```c
#define PWM_PERIOD           500        // 占空比精度 = 0.2%
#define MAX_SPEED_PWM        500        // 最大PWM值
#define MIN_SPEED_PWM        0          // 最小PWM值
```

## PWM 占空比设置方法

占空比与转速的对应关系保持不变：

```c
// 设置PWM占空比（示例）
void Motor_SetPWM(uint16_t pwm_value)
{
    // pwm_value 范围：0 ~ 500
    // pwm_value = 0   → 占空比 0%   (电机停止)
    // pwm_value = 250 → 占空比 50%  (半速)
    // pwm_value = 500 → 占空比 100% (全速)
    
    __HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_2, pwm_value);
}

// 设置RPM对应的PWM
void Motor_SetSpeed(uint16_t target_rpm)
{
    uint16_t pwm_value = (target_rpm * PWM_PERIOD) / MAX_RPM;
    Motor_SetPWM(pwm_value);
}
```

## 性能提升

### 优势

| 项目 | 提升效果 |
|------|--------|
| **频率提升** | 500Hz → 10.26kHz (×20.6倍) |
| **PWM时间分辨率** | 2.004ms → 0.0974ms (提高20倍) |
| **电机响应速度** | 更快、更平滑 |
| **电机噪音** | 降低（10kHz超出人耳范围） |
| **精度** | 占空比精度0.2%保持不变 |
| **兼容性** | 完全保持，无需改动控制代码 |

### PWM时序对比

```
原配置（500Hz）：
━━━━━┓    ┌━━━━━┓    ┌━━━━━┓    ┌━━━━━
      ┗━━━━┛    ┗━━━━┛    ┗━━━━┛
└─────────────┬──────────────┘
    周期: 2ms (500Hz)
    
新配置（10.26kHz）：
━┓ ┌━┓ ┌━┓ ┌━┓ ┌━┓ ┌━┓ ┌━┓ ┌━┓ ┌━┓ ┌━┓ ┌━
 ┗━┛ ┗━┛ ┗━┛ ┗━┛ ┗━┛ ┗━┛ ┗━┛ ┗━┛ ┗━┛ ┗━┛ ┗
└─┬┘
 周期: 0.0974ms (10.26kHz)
```

## 编译测试

配置修改完成后：

```bash
# 1. 清空build目录
cd app
rm -rf build

# 2. 编译
make

# 3. 烧录并测试
# 使用示波器测量PA7 (TIM3_CH2)，验证频率为10.26kHz
```

## 预期结果

使用示波器测量PA7引脚应看到：

- **频率**: 10.26kHz (±2%)
- **幅度**: 0~3.3V
- **占空比**: 根据设置在0~100%范围内调节
- **波形**: 标准PWM方波，无明显抖动

## 注意事项

⚠️ **重要**

1. **不需要修改motor_ctrl代码** - 占空比精度保持，所有计算自动适配
2. **PWM_PERIOD仍为500** - 这是关键，保证占空比精度不变
3. **电源供应** - 确保12V电源能提供足够电流
4. **EMI考虑** - 10kHz频率可能产生更多高频干扰，建议加滤波电容

## 回滚方法

如需恢复500Hz，只需改回Prescaler：

```c
htim3.Init.Prescaler = 143;    // 恢复原值
// Period 保持 500
```

