# 电机控制I2C通信协议规范

## 1. 基本信息
- 通信方式：I2C
- motor从机地址：0x30
- 时钟频率：400kHz（快速模式，Fast-mode）

## 2. 命令格式
每个I2C传输包都由以下部分组成：
- 命令字节（1字节）
- 数据字节（0-3字节，取决于命令类型）

### 2.1 命令字节格式
```
[7:6] 命令类型
[5]   速率控制（0:标准/快速模式，1:高速模式）
[4:0] 命令参数
```

### 2.2 高速模式切换
- 切换到高速模式：
  1. 发送特殊序列 0xF0
  2. 等待从机应答
  3. 切换时钟频率
  4. 后续命令[5]位置1

- 返回标准/快速模式：
  1. 发送特殊序列 0xF1
  2. 等待从机应答
  3. 切换时钟频率
  4. 后续命令[5]位置0

## 3. 写命令列表（主机 -> 从机）

### 3.1 电机控制命令

#### CMD_MOTOR_CONTROL (0x10)
控制电机的运行状态和速度
- 命令字节：0x10
- 数据字节1：控制标志
  ```
  [7]   - 1:启动 0:停止
  [6]   - 1:正转 0:反转
  [5:0] - 保留
  ```
- 数据字节2：目标转速高8位
- 数据字节3：目标转速低8位
  - 速度单位：RPM（每分钟转数）
  - 速度范围：0-65535 RPM
  - 当控制标志[7]=0（停止）时，速度值将被忽略
  - 实际最大转速取决于电机规格

## 4. 读命令列表（从机 -> 主机）

### 4.1 状态读取命令

#### CMD_READ_STATUS (0x40)
读取电机完整状态（包括运行状态和当前速度）
- 命令字节：0x40
- 返回数据：3字节
  - 字节1：状态标志
    ```
    [7]   - 1:运行中 0:已停止
    [6]   - 1:正转 0:反转
    [5]   - 1:错误状态 0:正常
    [4:0] - 错误代码（当[5]=1时有效）
    ```
  - 字节2：当前转速高8位
  - 字节3：当前转速低8位
    - 速度单位：RPM（每分钟转数）
    - 速度范围：0-65535 RPM
    - 基于FG信号实时测量得到的实际转速

## 5. 通信示例

### 5.1 启动电机（正转，3000 RPM）
```
主机 -> 从机：0x10 0x80 0x0B 0xB8
（命令字节，控制标志[启动+正转]，转速高8位，转速低8位）
注：0x0BB8 = 3000 RPM
```

### 5.2 读取当前状态和转速
```
主机 -> 从机：0x40
从机 -> 主机：0x80 0x0B 0xB8
（状态字节[运行+正转]，转速高8位，转速低8位）
注：返回值 0x0BB8 = 3000 RPM，表示当前电机正在以3000RPM的速度运行
```

### 5.3 停止电机
```
主机 -> 从机：0x10 0x00
```

## 6. 错误代码定义

| 错误代码 | 描述 |
|---------|------|
| 0x01    | 过流保护 |
| 0x02    | 过压保护 |
| 0x03    | 欠压保护 |
| 0x04    | 过温保护 |
| 0x05    | 堵转保护 |
| 0x06    | 通信超时 |

## 7. 实现建议

### 7.1 从机实现
- 采用状态机处理接收到的命令
- 使用缓冲区存储接收到的数据
- 实现看门狗功能，防止通信中断导致电机失控
- 实现电机软启动和软停止功能

### 7.2 主机实现
- 实现命令重试机制
- 定期读取电机状态进行监控
- 实现电机异常状态处理流程
- 必要时实现命令队列，确保命令按序执行

## 8. 注意事项
1. 所有未使用的命令字节保留供将来使用
2. 建议在每次设置新的速度值前确认电机状态
3. 通信超时处理：从机在3秒未收到有效命令时自动停止电机
4. 主机应定期发送状态查询命令以确保通信正常
5. 电机启动时建议从低速渐进到目标速度

## 9. 高速通信模式说明

### 9.1 通信速率
- 标准模式（Sm）：100 kHz
- 快速模式（Fm）：400 kHz（默认配置）

